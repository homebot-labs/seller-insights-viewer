<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Seller Listing Insights Viewer</title>
  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: #f5f5f5;
      color: #333;
      line-height: 1.5;
    }

    .container {
      max-width: 1400px;
      margin: 0 auto;
      padding: 20px;
    }

    header {
      background: #1a73e8;
      color: white;
      padding: 20px;
      margin-bottom: 20px;
    }

    header h1 {
      font-size: 24px;
      font-weight: 500;
    }

    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 16px;
      margin-bottom: 20px;
    }

    .stat-card {
      background: white;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }

    .stat-card h3 {
      font-size: 12px;
      color: #666;
      text-transform: uppercase;
      margin-bottom: 8px;
    }

    .stat-card .value {
      font-size: 28px;
      font-weight: 600;
      color: #1a73e8;
    }

    .filters {
      background: white;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
      margin-bottom: 20px;
      display: flex;
      gap: 16px;
      flex-wrap: wrap;
      align-items: flex-end;
    }

    .filter-group {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .filter-group label {
      font-size: 12px;
      color: #666;
      font-weight: 500;
    }

    .filter-group input,
    .filter-group select {
      padding: 8px 12px;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-size: 14px;
      min-width: 150px;
    }

    .filter-group input:focus,
    .filter-group select:focus {
      outline: none;
      border-color: #1a73e8;
    }

    button {
      background: #1a73e8;
      color: white;
      border: none;
      padding: 8px 20px;
      border-radius: 4px;
      font-size: 14px;
      cursor: pointer;
      transition: background 0.2s;
    }

    button:hover {
      background: #1557b0;
    }

    button.secondary {
      background: #f5f5f5;
      color: #333;
    }

    button.secondary:hover {
      background: #e0e0e0;
    }

    .table-container {
      background: white;
      border-radius: 8px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
      overflow: hidden;
    }

    table {
      width: 100%;
      border-collapse: collapse;
    }

    th, td {
      padding: 12px 16px;
      text-align: left;
      border-bottom: 1px solid #eee;
    }

    th {
      background: #f9f9f9;
      font-weight: 600;
      font-size: 12px;
      text-transform: uppercase;
      color: #666;
    }

    tr:hover {
      background: #f5f8ff;
    }

    .truncate {
      max-width: 200px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .tag {
      display: inline-block;
      padding: 2px 8px;
      border-radius: 12px;
      font-size: 12px;
      font-weight: 500;
    }

    .tag.prod { background: #e8f5e9; color: #2e7d32; }
    .tag.staging { background: #fff3e0; color: #ef6c00; }
    .tag.local { background: #e3f2fd; color: #1565c0; }

    .pagination {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 16px;
      border-top: 1px solid #eee;
    }

    .pagination-info {
      font-size: 14px;
      color: #666;
    }

    .pagination-buttons {
      display: flex;
      gap: 8px;
    }

    .clickable {
      cursor: pointer;
      color: #1a73e8;
    }

    .clickable:hover {
      text-decoration: underline;
    }

    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.5);
      z-index: 1000;
      align-items: center;
      justify-content: center;
    }

    .modal.active {
      display: flex;
    }

    .modal-content {
      background: white;
      border-radius: 8px;
      max-width: 900px;
      max-height: 90vh;
      width: 90%;
      overflow: auto;
    }

    .modal-header {
      padding: 20px;
      border-bottom: 1px solid #eee;
      display: flex;
      justify-content: space-between;
      align-items: center;
      position: sticky;
      top: 0;
      background: white;
    }

    .modal-header h2 {
      font-size: 18px;
    }

    .modal-close {
      background: none;
      border: none;
      font-size: 24px;
      cursor: pointer;
      color: #666;
      padding: 0;
    }

    .modal-body {
      padding: 20px;
    }

    .detail-section {
      margin-bottom: 24px;
    }

    .detail-section h3 {
      font-size: 14px;
      color: #666;
      margin-bottom: 8px;
      text-transform: uppercase;
    }

    .detail-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 16px;
    }

    .detail-item {
      background: #f9f9f9;
      padding: 12px;
      border-radius: 4px;
    }

    .detail-item label {
      font-size: 12px;
      color: #666;
      display: block;
      margin-bottom: 4px;
    }

    .detail-item .value {
      font-weight: 500;
      word-break: break-all;
    }

    pre {
      background: #f5f5f5;
      padding: 16px;
      border-radius: 4px;
      overflow-x: auto;
      font-size: 13px;
      max-height: 300px;
      overflow-y: auto;
    }

    .loading {
      text-align: center;
      padding: 40px;
      color: #666;
    }

    .error {
      background: #ffebee;
      color: #c62828;
      padding: 16px;
      border-radius: 4px;
      margin-bottom: 20px;
    }
  </style>
</head>
<body>
  <header>
    <div class="container">
      <h1>Seller Listing Insights Viewer</h1>
    </div>
  </header>

  <div class="container">
    <div class="stats-grid" id="stats">
      <div class="stat-card">
        <h3>Total Records</h3>
        <div class="value" id="totalRecords">-</div>
      </div>
      <div class="stat-card">
        <h3>Unique Listings</h3>
        <div class="value" id="uniqueListings">-</div>
      </div>
      <div class="stat-card">
        <h3>Unique Customers</h3>
        <div class="value" id="uniqueCustomers">-</div>
      </div>
      <div class="stat-card">
        <h3>Avg Input Tokens</h3>
        <div class="value" id="avgInputTokens">-</div>
      </div>
      <div class="stat-card">
        <h3>Avg Output Tokens</h3>
        <div class="value" id="avgOutputTokens">-</div>
      </div>
    </div>

    <div class="filters">
      <div class="filter-group">
        <label>Environment</label>
        <select id="environmentFilter">
          <option value="">All</option>
        </select>
      </div>
      <div class="filter-group">
        <label>Listing ID</label>
        <input type="text" id="listingIdFilter" placeholder="Enter listing ID">
      </div>
      <div class="filter-group">
        <label>Customer ID</label>
        <input type="text" id="customerIdFilter" placeholder="Enter customer ID">
      </div>
      <button onclick="applyFilters()">Apply Filters</button>
      <button class="secondary" onclick="clearFilters()">Clear</button>
    </div>

    <div id="error" class="error" style="display: none;"></div>

    <div class="table-container">
      <table>
        <thead>
          <tr>
            <th>Timestamp</th>
            <th>Environment</th>
            <th>Model</th>
            <th>Listing ID</th>
            <th>Customer ID</th>
            <th>Input Tokens</th>
            <th>Output Tokens</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody id="tableBody">
          <tr>
            <td colspan="8" class="loading">Loading...</td>
          </tr>
        </tbody>
      </table>
      <div class="pagination">
        <div class="pagination-info" id="paginationInfo">-</div>
        <div class="pagination-buttons">
          <button class="secondary" id="prevBtn" onclick="prevPage()" disabled>Previous</button>
          <button class="secondary" id="nextBtn" onclick="nextPage()" disabled>Next</button>
        </div>
      </div>
    </div>
  </div>

  <div class="modal" id="detailModal">
    <div class="modal-content">
      <div class="modal-header">
        <h2>Insight Details</h2>
        <button class="modal-close" onclick="closeModal()">&times;</button>
      </div>
      <div class="modal-body" id="modalBody">
        <!-- Content will be loaded dynamically -->
      </div>
    </div>
  </div>

  <script>
    let currentOffset = 0;
    const limit = 50;
    let totalRecords = 0;
    let currentFilters = {};

    async function loadStats() {
      try {
        const response = await fetch('/api/stats');
        const stats = await response.json();

        document.getElementById('totalRecords').textContent = Number(stats.totalRecords).toLocaleString();
        document.getElementById('uniqueListings').textContent = Number(stats.uniqueListings).toLocaleString();
        document.getElementById('uniqueCustomers').textContent = Number(stats.uniqueCustomers).toLocaleString();
        document.getElementById('avgInputTokens').textContent = Math.round(stats.avgInputTokens).toLocaleString();
        document.getElementById('avgOutputTokens').textContent = Math.round(stats.avgOutputTokens).toLocaleString();
      } catch (error) {
        console.error('Error loading stats:', error);
      }
    }

    async function loadEnvironments() {
      try {
        const response = await fetch('/api/environments');
        const environments = await response.json();

        const select = document.getElementById('environmentFilter');
        environments.forEach(env => {
          const option = document.createElement('option');
          option.value = env;
          option.textContent = env;
          select.appendChild(option);
        });
      } catch (error) {
        console.error('Error loading environments:', error);
      }
    }

    async function loadData() {
      const tbody = document.getElementById('tableBody');
      tbody.innerHTML = '<tr><td colspan="8" class="loading">Loading...</td></tr>';

      try {
        const params = new URLSearchParams({
          limit: limit.toString(),
          offset: currentOffset.toString(),
          ...currentFilters
        });

        const response = await fetch(`/api/insights?${params}`);
        const result = await response.json();

        if (result.error) {
          throw new Error(result.details || result.error);
        }

        totalRecords = result.pagination.total;
        renderTable(result.data);
        updatePagination();
        hideError();
      } catch (error) {
        showError(error.message);
        tbody.innerHTML = '<tr><td colspan="8" class="loading">Error loading data</td></tr>';
      }
    }

    function renderTable(data) {
      const tbody = document.getElementById('tableBody');

      if (data.length === 0) {
        tbody.innerHTML = '<tr><td colspan="8" class="loading">No data found</td></tr>';
        return;
      }

      tbody.innerHTML = data.map(row => `
        <tr>
          <td>${formatDate(row.timestamp)}</td>
          <td><span class="tag ${row.environment}">${row.environment}</span></td>
          <td>${row.modelName || '-'}</td>
          <td class="truncate clickable" onclick="filterByListing('${row.listingId}')" title="${row.listingId}">${row.listingId || '-'}</td>
          <td class="truncate clickable" onclick="filterByCustomer('${row.customerId}')" title="${row.customerId}">${row.customerId || '-'}</td>
          <td>${Number(row.inputTokens).toLocaleString()}</td>
          <td>${Number(row.outputTokens).toLocaleString()}</td>
          <td><button onclick="showDetails('${row.id}')">View</button></td>
        </tr>
      `).join('');
    }

    function formatDate(timestamp) {
      if (!timestamp) return '-';
      const date = new Date(timestamp);
      return date.toLocaleString();
    }

    function updatePagination() {
      const start = currentOffset + 1;
      const end = Math.min(currentOffset + limit, totalRecords);
      document.getElementById('paginationInfo').textContent = `Showing ${start}-${end} of ${totalRecords}`;

      document.getElementById('prevBtn').disabled = currentOffset === 0;
      document.getElementById('nextBtn').disabled = currentOffset + limit >= totalRecords;
    }

    function prevPage() {
      if (currentOffset > 0) {
        currentOffset -= limit;
        loadData();
      }
    }

    function nextPage() {
      if (currentOffset + limit < totalRecords) {
        currentOffset += limit;
        loadData();
      }
    }

    function applyFilters() {
      currentFilters = {};
      currentOffset = 0;

      const environment = document.getElementById('environmentFilter').value;
      const listingId = document.getElementById('listingIdFilter').value;
      const customerId = document.getElementById('customerIdFilter').value;

      if (environment) currentFilters.environment = environment;
      if (listingId) currentFilters.listingId = listingId;
      if (customerId) currentFilters.customerId = customerId;

      loadData();
    }

    function clearFilters() {
      document.getElementById('environmentFilter').value = '';
      document.getElementById('listingIdFilter').value = '';
      document.getElementById('customerIdFilter').value = '';
      currentFilters = {};
      currentOffset = 0;
      loadData();
    }

    function filterByListing(listingId) {
      document.getElementById('listingIdFilter').value = listingId;
      applyFilters();
    }

    function filterByCustomer(customerId) {
      document.getElementById('customerIdFilter').value = customerId;
      applyFilters();
    }

    async function showDetails(id) {
      try {
        const response = await fetch(`/api/insights/${id}`);
        const data = await response.json();

        if (data.error) {
          throw new Error(data.details || data.error);
        }

        const modalBody = document.getElementById('modalBody');
        modalBody.innerHTML = `
          <div class="detail-section">
            <h3>Basic Information</h3>
            <div class="detail-grid">
              <div class="detail-item">
                <label>ID</label>
                <div class="value">${data.id}</div>
              </div>
              <div class="detail-item">
                <label>Timestamp</label>
                <div class="value">${formatDate(data.timestamp)}</div>
              </div>
              <div class="detail-item">
                <label>Environment</label>
                <div class="value"><span class="tag ${data.environment}">${data.environment}</span></div>
              </div>
              <div class="detail-item">
                <label>Model</label>
                <div class="value">${data.modelName || '-'}</div>
              </div>
            </div>
          </div>

          <div class="detail-section">
            <h3>Identifiers</h3>
            <div class="detail-grid">
              <div class="detail-item">
                <label>Listing ID</label>
                <div class="value">${data.listingId || '-'}</div>
              </div>
              <div class="detail-item">
                <label>Customer ID</label>
                <div class="value">${data.customerId || '-'}</div>
              </div>
              <div class="detail-item">
                <label>Client ID</label>
                <div class="value">${data.clientId || '-'}</div>
              </div>
              <div class="detail-item">
                <label>Home ID</label>
                <div class="value">${data.homeId || '-'}</div>
              </div>
            </div>
          </div>

          <div class="detail-section">
            <h3>Token Usage</h3>
            <div class="detail-grid">
              <div class="detail-item">
                <label>Input Tokens</label>
                <div class="value">${Number(data.inputTokens).toLocaleString()}</div>
              </div>
              <div class="detail-item">
                <label>Output Tokens</label>
                <div class="value">${Number(data.outputTokens).toLocaleString()}</div>
              </div>
            </div>
          </div>

          <div class="detail-section">
            <h3>Empty Prompt</h3>
            <pre>${escapeHtml(data.emptyPrompt || '-')}</pre>
          </div>

          <div class="detail-section">
            <h3>Rendered Prompt</h3>
            <pre>${escapeHtml(data.renderedPrompt || '-')}</pre>
          </div>

          <div class="detail-section">
            <h3>Input Payload</h3>
            <pre>${formatJson(data.inputPayload)}</pre>
          </div>

          <div class="detail-section">
            <h3>Output Payload</h3>
            <pre>${formatJson(data.outputPayload)}</pre>
          </div>
        `;

        document.getElementById('detailModal').classList.add('active');
      } catch (error) {
        showError(error.message);
      }
    }

    function closeModal() {
      document.getElementById('detailModal').classList.remove('active');
    }

    function escapeHtml(text) {
      if (!text) return '-';
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    function formatJson(str) {
      if (!str) return '-';
      try {
        const obj = JSON.parse(str);
        return escapeHtml(JSON.stringify(obj, null, 2));
      } catch {
        return escapeHtml(str);
      }
    }

    function showError(message) {
      const errorEl = document.getElementById('error');
      errorEl.textContent = message;
      errorEl.style.display = 'block';
    }

    function hideError() {
      document.getElementById('error').style.display = 'none';
    }

    // Close modal on escape key
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') {
        closeModal();
      }
    });

    // Close modal on click outside
    document.getElementById('detailModal').addEventListener('click', (e) => {
      if (e.target.id === 'detailModal') {
        closeModal();
      }
    });

    // Initial load
    loadStats();
    loadEnvironments();
    loadData();
  </script>
</body>
</html>
